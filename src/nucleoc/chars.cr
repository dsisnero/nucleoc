# Character utilities for nucleoc fuzzy matching
module Nucleoc
  enum CharClass
    Whitespace
    NonWord
    Delimiter
    Lower
    Upper
    Letter
    Number
  end

  module Chars
    def self.upper_case?(c : Char) : Bool
      c.uppercase?
    end

    def self.to_lower_case(c : Char) : Char
      c.downcase
    end

    private def self.ascii_char_class(c : UInt8, config : Config) : CharClass
      if c >= 'a'.ord && c <= 'z'.ord
        CharClass::Lower
      elsif c >= 'A'.ord && c <= 'Z'.ord
        CharClass::Upper
      elsif c >= '0'.ord && c <= '9'.ord
        CharClass::Number
      elsif c.chr.ascii_whitespace?
        CharClass::Whitespace
      elsif config.delimiter_chars.includes?(c.chr)
        CharClass::Delimiter
      else
        CharClass::NonWord
      end
    end

    private def self.non_ascii_char_class(c : Char) : CharClass
      if c.lowercase?
        CharClass::Lower
      elsif upper_case?(c)
        CharClass::Upper
      elsif c.number?
        CharClass::Number
      elsif c.letter?
        CharClass::Letter
      elsif c.whitespace?
        CharClass::Whitespace
      else
        CharClass::NonWord
      end
    end

    def self.char_class(c : Char, config : Config) : CharClass
      if c.ascii?
        ascii_char_class(c.ord.to_u8, config)
      else
        non_ascii_char_class(c)
      end
    end

    def self.char_class_and_normalize(c : Char, config : Config) : Tuple(Char, CharClass)
      char_class = char_class(c, config)
      {normalize(c, config), char_class}
    end

    def self.normalize(c : Char, config : Config) : Char
      result = c
      result = to_lower_case(result) if config.ignore_case?

      # Apply character normalization if enabled
      if config.normalize?
        # outside checked blocks
        if c < '\u{a0}' || c >= '\u{20A0}'
          return result
        end
        # Latin-1 Supplement, Extended-A, Extended-B
        if c <= '\u{29f}'
          return LATIN_1AB[c.ord - '\u{a0}'.ord]
        end
        # between blocks
        if c < '\u{1e00}'
          return result
        end
        # Latin Extended Additional
        if c <= '\u{1eff}'
          return LATIN_EXTENDED_ADDITIONAL[c.ord - '\u{1e00}'.ord]
        end
        # between blocks
        if c < '\u{2070}'
          return result
        end
        # Superscripts and subscripts
        return SUPERSCRIPTS_AND_SUBSCRIPTS[c.ord - '\u{2070}'.ord]
      end

      result
    end

    # Return the first codepoint of each grapheme (special casing CRLF like rust)
    def self.graphemes(text : String) : Array(Char)
      chars = text.chars
      res = [] of Char
      i = 0
      while i < chars.size
        if chars[i] == '\r' && i + 1 < chars.size && chars[i + 1] == '\n'
          res << '\n'
          i += 2
          next
        end
        c = chars[i]
        # Skip basic combining marks (attach to previous grapheme)
        if (0x0300..0x036F).includes?(c.ord) && !res.empty?
          i += 1
          next
        end
        res << c
        i += 1
      end
      res
    end

    # Character normalization tables for Latin script to ASCII
    # Generated from Rust nucleo_rust/matcher/src/chars/normalize.rs

    private LATIN_1AB = [
      '\u{a0}',
      '!',
      '¢',
      '£',
      '¤',
      '¥',
      '¦',
      '§',
      '¨',
      '©',
      'a',
      '«',
      '¬',
      '\u{ad}',
      '®',
      '¯',
      '°',
      '±',
      '2',
      '3',
      '´',
      'µ',
      '¶',
      '·',
      '¸',
      '1',
      '0',
      '»',
      '¼',
      '½',
      '¾',
      '?',
      'A',
      'A',
      'A',
      'A',
      'A',
      'A',
      'Æ',
      'C',
      'E',
      'E',
      'E',
      'E',
      'I',
      'I',
      'I',
      'I',
      'D',
      'N',
      'O',
      'O',
      'O',
      'O',
      'O',
      '×',
      'O',
      'U',
      'U',
      'U',
      'U',
      'Y',
      'Þ',
      's',
      'a',
      'a',
      'a',
      'a',
      'a',
      'a',
      'æ',
      'c',
      'e',
      'e',
      'e',
      'e',
      'i',
      'i',
      'i',
      'i',
      'd',
      'n',
      'o',
      'o',
      'o',
      'o',
      'o',
      '÷',
      'o',
      'u',
      'u',
      'u',
      'u',
      'y',
      'þ',
      'y',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'C',
      'c',
      'C',
      'c',
      'C',
      'c',
      'C',
      'c',
      'D',
      'd',
      'D',
      'd',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'G',
      'g',
      'G',
      'g',
      'G',
      'g',
      'G',
      'g',
      'H',
      'h',
      'H',
      'h',
      'I',
      'i',
      'I',
      'i',
      'I',
      'i',
      'I',
      'i',
      'I',
      'i',
      'Ĳ',
      'ĳ',
      'J',
      'j',
      'K',
      'k',
      'ĸ',
      'L',
      'l',
      'L',
      'l',
      'L',
      'l',
      'L',
      'l',
      'L',
      'l',
      'N',
      'n',
      'N',
      'n',
      'N',
      'n',
      'n',
      'N',
      'n',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'Œ',
      'œ',
      'R',
      'r',
      'R',
      'r',
      'R',
      'r',
      'S',
      's',
      'S',
      's',
      'S',
      's',
      'S',
      's',
      'T',
      't',
      'T',
      't',
      'T',
      't',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'W',
      'w',
      'Y',
      'y',
      'Y',
      'Z',
      'z',
      'Z',
      'z',
      'Z',
      'z',
      's',
      'b',
      'B',
      'b',
      'b',
      'b',
      'ƅ',
      'O',
      'C',
      'c',
      'D',
      'D',
      'd',
      'd',
      'ƍ',
      'E',
      'e',
      'E',
      'F',
      'f',
      'G',
      'Ɣ',
      'h',
      'I',
      'I',
      'Ƙ',
      'k',
      'l',
      'ƛ',
      'M',
      'N',
      'n',
      'O',
      'O',
      'o',
      'Ƣ',
      'ƣ',
      'P',
      'p',
      'R',
      'S',
      's',
      'Ʃ',
      'l',
      't',
      'T',
      't',
      'T',
      'U',
      'u',
      'Ʊ',
      'V',
      'Y',
      'y',
      'Z',
      'z',
      'Ʒ',
      'Ƹ',
      'ƹ',
      'ƺ',
      'ƻ',
      'Ƽ',
      'ƽ',
      'ƾ',
      'ƿ',
      'ǀ',
      'ǁ',
      'ǂ',
      '!',
      'Ǆ',
      'ǅ',
      'ǆ',
      'Ǉ',
      'ǈ',
      'ǉ',
      'Ǌ',
      'ǋ',
      'ǌ',
      'A',
      'a',
      'I',
      'i',
      'O',
      'o',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'e',
      'A',
      'a',
      'A',
      'a',
      'Æ',
      'æ',
      'G',
      'g',
      'G',
      'g',
      'K',
      'k',
      'O',
      'o',
      'O',
      'o',
      'Ǯ',
      'ǯ',
      'j',
      'Ǳ',
      'ǲ',
      'ǳ',
      'G',
      'g',
      'Ƕ',
      'Ƿ',
      'N',
      'n',
      'A',
      'a',
      'Æ',
      'æ',
      'O',
      'o',
      'A',
      'a',
      'A',
      'a',
      'E',
      'e',
      'E',
      'e',
      'I',
      'i',
      'I',
      'i',
      'O',
      'o',
      'O',
      'o',
      'R',
      'r',
      'R',
      'r',
      'U',
      'u',
      'U',
      'u',
      'S',
      's',
      'T',
      't',
      'Ȝ',
      'ȝ',
      'H',
      'h',
      'N',
      'd',
      'Ȣ',
      'ȣ',
      'Z',
      'z',
      'A',
      'a',
      'E',
      'e',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'Y',
      'y',
      'l',
      'n',
      't',
      'j',
      'ȸ',
      'ȹ',
      'A',
      'C',
      'c',
      'L',
      'T',
      's',
      'z',
      'Ɂ',
      'ɂ',
      'B',
      'U',
      'V',
      'E',
      'e',
      'J',
      'j',
      'Q',
      'q',
      'R',
      'r',
      'Y',
      'y',
      'a',
      'a',
      'a',
      'b',
      'c',
      'c',
      'd',
      'd',
      'e',
      'e',
      'e',
      'e',
      'e',
      'e',
      'e',
      'j',
      'g',
      'g',
      'G',
      'g',
      'u',
      'h',
      'h',
      'h',
      'i',
      'i',
      'I',
      'l',
      'l',
      'l',
      'ɮ',
      'm',
      'm',
      'm',
      'n',
      'n',
      'N',
      'o',
      'ɶ',
      'ɷ',
      'ɸ',
      'r',
      'r',
      'r',
      'r',
      'r',
      'r',
      'r',
      'R',
      'R',
      's',
      'ʃ',
      'ʄ',
      'ʅ',
      'ʆ',
      't',
      't',
      'u',
      'ʊ',
      'v',
      'v',
      'w',
      'y',
      'Y',
      'z',
      'z',
      'ʒ',
      'ʓ',
      'ʔ',
      'ʕ',
      'ʖ',
      'c',
      'ʘ',
      'B',
      'e',
      'G',
      'H',
      'j',
      'k',
      'L',
    ]

    private LATIN_EXTENDED_ADDITIONAL = [
      'A',
      'a',
      'B',
      'b',
      'B',
      'b',
      'B',
      'b',
      'C',
      'c',
      'D',
      'e',
      'D',
      'd',
      'D',
      'd',
      'D',
      'd',
      'D',
      'd',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'F',
      'f',
      'G',
      'g',
      'H',
      'g',
      'H',
      'g',
      'H',
      'g',
      'H',
      'g',
      'H',
      'h',
      'I',
      'i',
      'I',
      'i',
      'K',
      'k',
      'K',
      'k',
      'K',
      'k',
      'L',
      'l',
      'L',
      'l',
      'L',
      'l',
      'L',
      'l',
      'M',
      'm',
      'M',
      'm',
      'M',
      'm',
      'N',
      'n',
      'N',
      'n',
      'N',
      'n',
      'N',
      'n',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'P',
      'p',
      'P',
      'p',
      'R',
      'r',
      'R',
      'r',
      'R',
      'r',
      'R',
      'r',
      'S',
      's',
      'S',
      's',
      'S',
      's',
      'S',
      's',
      'S',
      's',
      'T',
      't',
      'T',
      't',
      'T',
      't',
      'T',
      't',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'V',
      'v',
      'V',
      'v',
      'W',
      'w',
      'W',
      'w',
      'W',
      'w',
      'W',
      'w',
      'W',
      'j',
      'X',
      'x',
      'X',
      'x',
      'Y',
      'y',
      'Z',
      'z',
      'Z',
      'z',
      'Z',
      'z',
      'h',
      't',
      'w',
      'y',
      'a',
      'i',
      'f',
      'f',
      'ẞ',
      'ẟ',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'A',
      'a',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'E',
      'e',
      'I',
      'i',
      'I',
      'i',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'O',
      'o',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'U',
      'u',
      'Y',
      'y',
      'Y',
      'y',
      'Y',
      'y',
      'Y',
      'y',
      'Ỻ',
      'ỻ',
      'Ỽ',
      'ỽ',
      'Ỿ',
      'ỿ',
    ]

    private SUPERSCRIPTS_AND_SUBSCRIPTS = [
      '0',
      'i',
      '⁲',
      '⁳',
      '4',
      '5',
      '6',
      '7',
      '8',
      '0',
      '+',
      '-',
      '=',
      '(',
      ')',
      'n',
      '0',
      '1',
      '2',
      '3',
      '4',
      '5',
      '6',
      '7',
      '8',
      '9',
      '+',
      '-',
      '=',
      '(',
      ')',
      '₏',
      'a',
      'e',
      'o',
      'x',
      'e',
      'h',
      'k',
      'l',
      'm',
      'n',
      'p',
      's',
      't',
      '₝',
      '₞',
      '₟',
    ]
  end
end
